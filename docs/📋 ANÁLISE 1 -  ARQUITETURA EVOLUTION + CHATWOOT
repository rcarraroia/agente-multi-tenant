Excelente! Agora tenho informaÃ§Ãµes suficientes para compilar os documentos tÃ©cnicos. Vou estruturar as 3 anÃ¡lises completas:

ğŸ“‹ ANÃLISE 1: ARQUITETURA EVOLUTION + CHATWOOT
1. Contexto
O sistema multiagente precisa integrar WhatsApp via Evolution API com Chatwoot para permitir handoff humano quando necessÃ¡rio. A questÃ£o central Ã©: qual arquitetura de integraÃ§Ã£o escolher?

2. Pesquisa TÃ©cnica
2.1 O que Ã© Evolution API?
Evolution API Ã© uma API REST open-source para integraÃ§Ã£o WhatsApp que:

Suporta mÃºltiplas instÃ¢ncias WhatsApp simultÃ¢neas
Usa Baileys (protocolo WhatsApp Web nÃ£o-oficial)
Oferece webhooks para eventos em tempo real
Possui integraÃ§Ã£o nativa com Chatwoot
Fonte: Evolution API Introduction

2.2 O que Ã© Chatwoot?
Chatwoot Ã© uma plataforma open-source de atendimento ao cliente que:

Centraliza conversas de mÃºltiplos canais
Suporta Agent Bots para automaÃ§Ã£o
Possui API completa para criar conversas e mensagens
Implementa handoff bot â†’ humano via status de conversa
Fonte: Chatwoot API Documentation

2.3 IntegraÃ§Ã£o Nativa Evolution â†’ Chatwoot
A Evolution API oferece integraÃ§Ã£o nativa configurÃ¡vel via:

Endpoint: POST /chatwoot/set/{{instance}}

Payload:

{
  "enabled": true,
  "account_id": "123",
  "token": "chatwoot_admin_token",
  "url": "https://chatwoot.seu-dominio.com",
  "sign_msg": true,
  "reopen_conversation": false,
  "conversation_pending": true,
  "import_contacts": true,
  "name_inbox": "WhatsApp Instance"
}

O que acontece automaticamente:

Evolution cria inbox automaticamente no Chatwoot
Mensagens recebidas â†’ criadas no Chatwoot
Mensagens enviadas do Chatwoot â†’ encaminhadas via Evolution
Contatos importados automaticamente
Fontes:

Evolution API Chatwoot Integration
Set Chatwoot Documentation
2.4 Webhooks Evolution API
Webhooks disponÃ­veis:

Evento	Quando Dispara	Payload Essencial
QRCODE_UPDATED	QR Code gerado/atualizado	{event, instance, data: {qr}}
CONNECTION_UPDATE	Status conexÃ£o muda	{event, instance, data: {state, statusReason}}
MESSAGES_UPSERT	Nova mensagem recebida	{event, instance, data: {key, message}}
MESSAGES_UPDATE	Mensagem atualizada	{event, instance, data: {key, update}}
Fonte: Evolution API Webhooks

2.5 API Chatwoot
Workflow completo:

Criar Contato:

POST /api/v1/accounts/{account_id}/contacts

Criar Conversa:

POST /api/v1/accounts/{account_id}/conversations
Body: {source_id, inbox_id, contact_id, message}

Enviar Mensagem:

POST /api/v1/accounts/{account_id}/conversations/{conversation_id}/messages

Handoff Bot â†’ Humano:

Status pending = bot atende
Status open = humano atende
Trocar via: PUT /api/v1/accounts/{account_id}/conversations/{conversation_id}
Webhooks Chatwoot:

message_created - quando agente humano responde
conversation_status_changed - quando status muda
conversation_updated - quando conversa atualizada
Fontes:

Create Conversation API
Agent Bots Handoff
3. AnÃ¡lise Comparativa
OpÃ§Ã£o A: Evolution â†’ Chatwoot (IntegraÃ§Ã£o Nativa Direta)
Renderizando diagrama...

Como funciona:

Evolution configurado com integraÃ§Ã£o nativa Chatwoot
TODAS as mensagens fluem automaticamente para Chatwoot
Nosso backend apenas consulta APIs para monitorar/relatÃ³rios
PrÃ³s:

âœ… Zero overhead de desenvolvimento inicial
âœ… Mensagens sincronizadas automaticamente
âœ… Menor latÃªncia (comunicaÃ§Ã£o direta)
âœ… Simplicidade operacional
âœ… Menos pontos de falha
Contras:

âŒ Pouco controle sobre o fluxo de mensagens
âŒ DifÃ­cil aplicar lÃ³gica customizada (filtros, roteamento)
âŒ Nosso backend fica "fora do loop" principal
âŒ Bug conhecido: contexto de mensagens citadas perdido (Issue #2065)
âŒ DependÃªncia total da integraÃ§Ã£o nativa (bugs afetam diretamente)
Quando usar:

Sistema simples onde Chatwoot Ã© o centro de tudo
NÃ£o precisa de lÃ³gica complexa de roteamento
Equipe pequena querendo setup rÃ¡pido
OpÃ§Ã£o B: Backend Centralizado (OrquestraÃ§Ã£o Total)
Renderizando diagrama...

Como funciona:

Evolution sem integraÃ§Ã£o Chatwoot
Webhook Evolution â†’ Nosso Backend
Backend decide quando/como enviar para Chatwoot
Webhook Chatwoot â†’ Backend â†’ Evolution
PrÃ³s:

âœ… Controle total do fluxo
âœ… LÃ³gica customizada (filtros, roteamento, transformaÃ§Ãµes)
âœ… FÃ¡cil adicionar analytics/logs
âœ… Pode aplicar rate limiting
âœ… AbstraÃ§Ã£o - trocar Evolution/Chatwoot sem refatoraÃ§Ã£o total
âœ… Multitenancy mais robusto
Contras:

âŒ Desenvolvimento mais complexo
âŒ Maior latÃªncia (hop adicional)
âŒ Mais pontos de falha
âŒ Precisa gerenciar fila de mensagens
âŒ Custo de manutenÃ§Ã£o maior
Quando usar:

Precisa de lÃ³gica complexa de roteamento
Sistema multicanal alÃ©m de WhatsApp
Analytics profundos necessÃ¡rios
Controle fino sobre dados e privacidade
OpÃ§Ã£o C: HÃ­brido (IntegraÃ§Ã£o Nativa + Controle Backend)
Renderizando diagrama...

Como funciona:

Evolution COM integraÃ§Ã£o nativa Chatwoot (mensagens fluem automaticamente)
Evolution TAMBÃ‰M envia webhooks para nosso backend
Backend intercepta eventos importantes (handoff, mÃ©tricas)
Backend pode intervir via API Chatwoot quando necessÃ¡rio
PrÃ³s:

âœ… Melhor dos dois mundos
âœ… Mensagens fluem automaticamente (integraÃ§Ã£o nativa)
âœ… Backend ainda "vÃª tudo" via webhooks
âœ… Pode adicionar lÃ³gica sem bloquear fluxo principal
âœ… Baixa latÃªncia no caminho crÃ­tico
âœ… Controle seletivo onde importa
Contras:

âŒ Complexidade moderada de setup
âŒ Precisa gerenciar dois canais de eventos
âŒ Risco de mensagens duplicadas se nÃ£o implementado corretamente
âŒ DepuraÃ§Ã£o mais difÃ­cil (mÃºltiplos caminhos)
Quando usar:

Quer simplicidade da integraÃ§Ã£o nativa
MAS precisa de analytics/controle em pontos especÃ­ficos
Sistema crescendo gradualmente em complexidade
4. Tabela Comparativa Final
CritÃ©rio	OpÃ§Ã£o A (Nativa)	OpÃ§Ã£o B (Backend)	OpÃ§Ã£o C (HÃ­brido)
Complexidade	ğŸŸ¢ Baixa	ğŸ”´ Alta	ğŸŸ¡ MÃ©dia
LatÃªncia	ğŸŸ¢ Baixa	ğŸ”´ MÃ©dia	ğŸŸ¢ Baixa
Controle	ğŸ”´ Baixo	ğŸŸ¢ Total	ğŸŸ¡ Seletivo
ManutenÃ§Ã£o	ğŸŸ¢ Baixa	ğŸ”´ Alta	ğŸŸ¡ MÃ©dia
Escalabilidade	ğŸŸ¡ MÃ©dia	ğŸŸ¢ Alta	ğŸŸ¢ Alta
Custo Dev	ğŸŸ¢ Baixo	ğŸ”´ Alto	ğŸŸ¡ MÃ©dio
Flexibilidade	ğŸ”´ Baixa	ğŸŸ¢ MÃ¡xima	ğŸŸ¡ Alta
AbstraÃ§Ã£o	ğŸ”´ Baixa	ğŸŸ¢ Alta	ğŸŸ¡ MÃ©dia
5. RecomendaÃ§Ã£o
ğŸ¯ OPÃ‡ÃƒO C - ARQUITETURA HÃBRIDA
Justificativa:

Fase 1 (MVP - 0-3 meses):

Use integraÃ§Ã£o nativa para validar produto rapidamente
Backend monitora via webhooks sem bloquear fluxo
Time focado em features, nÃ£o em infraestrutura
Fase 2 (Crescimento - 3-6 meses):

Backend jÃ¡ estÃ¡ "vendo tudo" via webhooks
Adicione lÃ³gicas especÃ­ficas (analytics, roteamento) progressivamente
Sem refatoraÃ§Ã£o grande
Fase 3 (Escala - 6+ meses):

Se necessÃ¡rio, migre gradualmente para OpÃ§Ã£o B
Desligue integraÃ§Ã£o nativa, mantenha webhooks
TransiÃ§Ã£o suave porque backend jÃ¡ estÃ¡ pronto
Pragmatismo:

VocÃª mencionou "custo Ã© fator" â†’ HÃ­brido Ã© custo-efetivo
"NÃ£o over-engineer" â†’ ComeÃ§a simples, cresce sob demanda
Multitenancy â†’ Backend monitora por tenant, integraÃ§Ã£o nativa facilita isolamento
6. ImplementaÃ§Ã£o Recomendada
6.1 Setup Inicial
Evolution API:

# Criar instÃ¢ncia com Chatwoot
POST /instance/create
{
  "instanceName": "tenant_123",
  "integration": "WHATSAPP-BAILEYS",
  "webhook": {
    "url": "https://backend.seu-dominio.com/webhooks/evolution",
    "events": ["QRCODE_UPDATED", "CONNECTION_UPDATE", "MESSAGES_UPSERT"]
  }
}

# Configurar Chatwoot na instÃ¢ncia
POST /chatwoot/set/tenant_123
{
  "enabled": true,
  "account_id": "123",
  "token": "xxx",
  "url": "https://chatwoot.seu-dominio.com",
  "conversation_pending": true,
  "reopen_conversation": false
}

Backend:

// Webhook Evolution - apenas monitora e registra
app.post('/webhooks/evolution', async (req, res) => {
  const { event, instance, data } = req.body;
  
  // Registrar evento para analytics
  await analytics.track(instance, event, data);
  
  // NÃ£o bloquear - Chatwoot jÃ¡ recebeu via integraÃ§Ã£o nativa
  res.status(200).send('OK');
  
  // Processar async
  if (event === 'CONNECTION_UPDATE' && data.state === 'close') {
    await notifyTenant(instance, 'whatsapp_disconnected');
  }
});

// Webhook Chatwoot - detectar handoff
app.post('/webhooks/chatwoot', async (req, res) => {
  const { event, conversation } = req.body;
  
  if (event === 'conversation_status_changed' && conversation.status === 'open') {
    // Handoff aconteceu - registrar para mÃ©tricas
    await metrics.increment('handoffs', { tenant: conversation.tenant_id });
  }
  
  res.status(200).send('OK');
});

6.2 Handoff Flow
Renderizando diagrama...

7. Riscos e MitigaÃ§Ãµes
Risco	Probabilidade	Impacto	MitigaÃ§Ã£o
Bug integraÃ§Ã£o nativa (ex: #2065)	ğŸŸ¡ MÃ©dia	ğŸ”´ Alto	Webhook backend detecta inconsistÃªncias, alerta equipe
Mensagens duplicadas	ğŸŸ¡ MÃ©dia	ğŸŸ¡ MÃ©dio	DeduplicaÃ§Ã£o via message_id no backend
Chatwoot down	ğŸŸ¢ Baixa	ğŸ”´ Alto	Evolution continua funcionando, queue mensagens no backend
Evolution down	ğŸŸ¡ MÃ©dia	ğŸ”´ Alto	Alertas imediatos, documentaÃ§Ã£o de restore
LatÃªncia webhook backend	ğŸŸ¡ MÃ©dia	ğŸŸ¢ Baixo	Processamento async, nÃ£o bloqueia fluxo principal
8. ReferÃªncias
DocumentaÃ§Ã£o Oficial:

Evolution API Chatwoot Integration
Evolution API Webhooks
Chatwoot Agent Bots
Chatwoot API Reference
ImplementaÃ§Ãµes Reais:

Evolution + Chatwoot Docker
Evolution API SDK
Issues Conhecidos:

Bug: Quoted Message Context Lost
Inbox Creation Failure
Update Todos
 Pesquisar documentaÃ§Ãµes oficiais (Evolution API e Chatwoot)
 AnÃ¡lise 1: Arquitetura Evolution + Chatwoot (modelos de integraÃ§Ã£o)
 Analisando modelos de instÃ¢ncias
 AnÃ¡lise 3: Fluxo QR Code + ReconexÃ£o (implementaÃ§Ã£o tÃ©cnica)
 Compilar e formatar os 3 documentos tÃ©cnicos
ğŸ“‹ ANÃLISE 2: MODELO DE INSTÃ‚NCIAS EVOLUTION
1. Contexto
Sistema multiagente com mÃºltiplos tenants (afiliados). Cada tenant terÃ¡ seu prÃ³prio nÃºmero WhatsApp conectado. QuestÃ£o central: Como gerenciar instÃ¢ncias Evolution API - uma por tenant? Compartilhada? Pool dinÃ¢mico?

2. Pesquisa TÃ©cnica
2.1 O que Ã© uma InstÃ¢ncia Evolution?
Uma instÃ¢ncia Evolution API representa:

Uma conexÃ£o WhatsApp independente
Um nÃºmero de telefone especÃ­fico
ConfiguraÃ§Ãµes isoladas (webhooks, integraÃ§Ãµes)
SessÃ£o Baileys prÃ³pria
Importante: 1 instÃ¢ncia = 1 nÃºmero WhatsApp. NÃ£o Ã© possÃ­vel mÃºltiplos nÃºmeros na mesma instÃ¢ncia.

Fonte: Evolution API Introduction

2.2 API de Gerenciamento de InstÃ¢ncias
OperaÃ§Ã£o	Endpoint	Payload Exemplo
Criar	POST /instance/create	{instanceName, integration: "WHATSAPP-BAILEYS"}
Deletar	DELETE /instance/delete/{instance}	-
Listar	GET /instance/fetchInstances	-
Status	GET /instance/connectionState/{instance}	-
Restart	PUT /instance/restart/{instance}	-
Criar InstÃ¢ncia - Payload Completo:

{
  "instanceName": "tenant_123_whatsapp",
  "integration": "WHATSAPP-BAILEYS",
  "number": "5511999999999",
  "webhook": {
    "url": "https://backend.com/webhooks/evolution",
    "webhook_by_events": true,
    "events": ["QRCODE_UPDATED", "CONNECTION_UPDATE", "MESSAGES_UPSERT"]
  }
}

Fontes:

Create Instance Postman
Evolution API v2.0 Documentation
2.3 Limites TÃ©cnicos e Performance
Consumo de Recursos:

Componente	Consumo por InstÃ¢ncia
MemÃ³ria (Baileys)	~300-500 MB
MemÃ³ria (Evolution API)	~512 MB configurado
CPU	Baixo em idle, picos em envio/recebimento
Disco	SessÃ£o ~10-50 MB
Problemas de Performance Identificados:

Baileys usa store in-memory por padrÃ£o (consome ~500 MB RAM por instÃ¢ncia para histÃ³rico completo)
MemÃ³ria aumenta gradualmente ao longo de dias (leak reportado em issues)
RecomendaÃ§Ã£o: usar experimentalStore para reduzir consumo
Escalabilidade:

Evolution API suporta horizontal scaling
MÃºltiplos containers compartilham Redis para estado de instÃ¢ncias
PostgreSQL com max_connections=1000 para pooling
S3/MinIO para arquivos (externaliza do container)
Fontes:

Baileys Memory Usage Issue
System Architecture Overview
2.4 SessÃµes vs InstÃ¢ncias
âš ï¸ CRÃTICO: Evolution API NÃƒO usa conceito de "mÃºltiplas sessÃµes por instÃ¢ncia"

1 instÃ¢ncia = 1 sessÃ£o WhatsApp = 1 nÃºmero
NÃ£o hÃ¡ compartilhamento de instÃ¢ncia entre nÃºmeros
Cada tenant PRECISA de sua prÃ³pria instÃ¢ncia
DiferenciaÃ§Ã£o de Mensagens:

Webhook inclui campo instance identificando de qual instÃ¢ncia veio
Filtrar mensagens por instance_name no backend
2.5 Custos Infraestrutura
Servidor Evolution API (Auto-hospedado):

Modelo	InstÃ¢ncias	RAM NecessÃ¡ria	CPU	Custo Estimado/mÃªs*
Pequeno	1-5	4 GB	2 cores	$10-20 (VPS bÃ¡sico)
MÃ©dio	5-20	8 GB	4 cores	$40-60 (VPS mÃ©dio)
Grande	20-50	16 GB	8 cores	$80-120 (VPS robusto)
Enterprise	50-200	32+ GB	16+ cores	$200-500 (cluster)
*Valores aproximados considerando DigitalOcean, Hetzner, AWS Lightsail

ObservaÃ§Ãµes:

Baileys (WhatsApp Web) Ã© gratuito - sem custos de API do WhatsApp
Cloud API oficial WhatsApp cobra por mensagem (~$0.005-0.01/msg)
Auto-hospedagem tem risco de banimento (protocolo nÃ£o-oficial)
Fonte: Evolution API Pricing Comparison

3. Modelos Comparados
Modelo A: 1 InstÃ¢ncia por Tenant (Isolamento Total)
Renderizando diagrama...

Como funciona:

Cada tenant tem instanceName Ãºnico (ex: tenant_123)
Criada quando tenant ativa assinatura WhatsApp
Deletada quando tenant cancela/desativa
PrÃ³s:

âœ… Isolamento total - falha em uma nÃ£o afeta outras
âœ… SeguranÃ§a - zero risco de misturar mensagens
âœ… ConfiguraÃ§Ã£o independente - webhooks, integraÃ§Ãµes por tenant
âœ… FÃ¡cil gestÃ£o - mapeamento 1:1 tenant â†’ instÃ¢ncia
âœ… Debugging simples - logs isolados por instÃ¢ncia
âœ… Conformidade LGPD - dados completamente segregados
Contras:

âŒ Custo mÃ©dio - RAM cresce linear com tenants (500 MB Ã— N)
âŒ Overhead de criaÃ§Ã£o - provisionar instÃ¢ncia por tenant
âŒ DesperdÃ­cio - tenant inativo ainda consome recursos
Quando usar:

Sistema SaaS multitenancy
Privacidade/LGPD Ã© crÃ­tica
Tenants pagantes (justifica custo)
AtÃ© ~200 tenants por servidor
Modelo B: 1 InstÃ¢ncia Compartilhada (Todos no Mesmo NÃºmero)
Renderizando diagrama...

Como funciona:

UMA instÃ¢ncia Evolution com nÃºmero da empresa
Todos os tenants usam o mesmo nÃºmero WhatsApp
Backend filtra mensagens por contexto (ex: nÃºmero do cliente)
PrÃ³s:

âœ… Custo baixÃ­ssimo - apenas 1 instÃ¢ncia (~500 MB RAM total)
âœ… Setup ultra-simples - uma vez sÃ³
âœ… Sem overhead - nenhuma criaÃ§Ã£o dinÃ¢mica
Contras:

âŒ NÃƒO SE APLICA AO SEU CASO
âŒ Cada tenant precisa de nÃºmero prÃ³prio (requisito do negÃ³cio)
âŒ ImpossÃ­vel diferenciar mensagens se todos no mesmo nÃºmero
âŒ Zero escalabilidade
Quando usar:

â›” NÃƒO USAR para sistema multiagente onde cada afiliado tem nÃºmero prÃ³prio
Modelo C: Pool DinÃ¢mico de InstÃ¢ncias (OrquestraÃ§Ã£o AvanÃ§ada)
Renderizando diagrama...

Como funciona:

Backend gerencia pool de instÃ¢ncias Evolution
InstÃ¢ncias criadas sob demanda
InstÃ¢ncias ociosas destruÃ­das apÃ³s X dias
Redis mantÃ©m mapeamento tenant â†’ instÃ¢ncia
PrÃ³s:

âœ… MÃ¡xima eficiÃªncia - paga sÃ³ pelo que usa
âœ… Auto-scaling - cresce/diminui com demanda real
âœ… Multi-servidor - distribui carga entre Evolution APIs
âœ… OtimizaÃ§Ã£o de custo - remove instÃ¢ncias ociosas
Contras:

âŒ Complexidade ALTA - precisa orquestraÃ§Ã£o sofisticada
âŒ Risco de perda de sessÃ£o - destruir instÃ¢ncia = perder sessÃ£o WhatsApp
âŒ ReconexÃ£o frequente - tenant precisaria re-escanear QR Code
âŒ Desenvolvimento custom - nÃ£o Ã© feature nativa Evolution
âŒ Over-engineering para sistemas pequenos/mÃ©dios
Quando usar:

Sistema com 1000+ tenants
Alto churn (muitos inativos)
Equipe DevOps madura
Kubernetes/orquestraÃ§Ã£o jÃ¡ implementada
4. AnÃ¡lise Custo-BenefÃ­cio
CenÃ¡rio Real: 100 Tenants Ativos
Modelo	RAM Total	Custo Servidor/mÃªs	Complexidade Dev	Tempo ImplementaÃ§Ã£o
A - 1:1	50 GB	$120	ğŸŸ¢ Baixa	1 semana
B - Compartilhado	0.5 GB	$10	â›” N/A	-
C - Pool DinÃ¢mico	25-50 GB*	$80-120	ğŸ”´ Alta	4-6 semanas
*varia com taxa de atividade

CenÃ¡rio Real: 500 Tenants Ativos
Modelo	RAM Total	Custo Servidor/mÃªs	Escalabilidade	GestÃ£o
A - 1:1	250 GB	$400-600 (cluster)	ğŸŸ¡ Escala vertical	Simples
C - Pool	125-200 GB	$300-400 (cluster)	ğŸŸ¢ Escala horizontal	Complexa
5. RecomendaÃ§Ã£o
ğŸ¯ MODELO A - 1 INSTÃ‚NCIA POR TENANT
Justificativa:

Requisito de NegÃ³cio:

Cada afiliado tem nÃºmero WhatsApp prÃ³prio
NÃ£o hÃ¡ opÃ§Ã£o de compartilhar - Modelo B inviÃ¡vel
Escolha real Ã©: A (simples) vs C (complexo)
Pragmatismo:

VocÃª pediu "nÃ£o over-engineer"
Modelo C Ã© overkill para 90% dos casos
ROI de Modelo C sÃ³ faz sentido com 1000+ tenants
Custo ViÃ¡vel:

100 tenants = $120/mÃªs servidor (~$1.20/tenant)
Afiliado paga assinatura â†’ custo diluÃ­do
Crescimento linear previsÃ­vel
OperaÃ§Ã£o Simples:

Criar instÃ¢ncia quando tenant ativa
Deletar quando cancela
Zero complexidade de orquestraÃ§Ã£o
Escalabilidade Gradual:

AtÃ© 200 tenants: 1 servidor ($120-200/mÃªs)
200-500: 2 servidores com balanceamento ($300/mÃªs)
500+: Considerar Modelo C (momento de investir)
Conformidade:

Isolamento total = LGPD tranquilo
Cada tenant "dono" de sua instÃ¢ncia
6. Roadmap de ImplementaÃ§Ã£o
Fase 1: Setup Infraestrutura (Semana 1)
Provisionar Servidor Evolution API:

# docker-compose.yml
version: '3'
services:
  evolution:
    image: atendai/evolution-api:latest
    environment:
      DATABASE_PROVIDER: postgresql
      DATABASE_URL: postgres://user:pass@db:5432/evolution
      REDIS_ENABLED: true
      REDIS_URI: redis://redis:6379
      S3_ENABLED: true
      S3_BUCKET: evolution-media
    deploy:
      resources:
        limits:
          memory: 16GB  # Para ~30 instÃ¢ncias

Configurar Redis (estado de instÃ¢ncias compartilhado)

Configurar PostgreSQL (dados persistentes)

Configurar S3/MinIO (arquivos de mÃ­dia)

Fase 2: Schema Database (Semana 1)
-- Adicionar colunas em multi_agent_tenants
ALTER TABLE multi_agent_tenants 
ADD COLUMN evolution_instance_id VARCHAR(255),  -- âœ… JÃ¡ existe
ADD COLUMN whatsapp_number VARCHAR(20),         -- âœ… JÃ¡ existe
ADD COLUMN whatsapp_status VARCHAR(20) DEFAULT 'pending',  -- â“ Adicionar
ADD COLUMN whatsapp_connected_at TIMESTAMPTZ,              -- â“ Adicionar
ADD COLUMN whatsapp_disconnected_at TIMESTAMPTZ,           -- â“ Adicionar
ADD COLUMN evolution_instance_created_at TIMESTAMPTZ;      -- â“ Adicionar

-- Valores possÃ­veis para whatsapp_status:
-- 'pending' - instÃ¢ncia nÃ£o criada
-- 'creating' - criando instÃ¢ncia
-- 'waiting_qr' - aguardando scan QR
-- 'connected' - WhatsApp conectado
-- 'disconnected' - WhatsApp desconectado
-- 'error' - erro na instÃ¢ncia

Fase 3: Backend - Gerenciamento de InstÃ¢ncias (Semana 2)
// services/evolution-instance-manager.ts

interface EvolutionInstance {
  instanceName: string;
  tenantId: string;
  status: 'pending' | 'creating' | 'waiting_qr' | 'connected' | 'disconnected';
}

class EvolutionInstanceManager {
  
  async createInstanceForTenant(tenantId: string): Promise<string> {
    const tenant = await db.multiAgentTenants.findUnique({ where: { id: tenantId } });
    
    if (tenant.evolution_instance_id) {
      throw new Error('Tenant jÃ¡ tem instÃ¢ncia');
    }
    
    const instanceName = `tenant_${tenantId}`;
    
    // Criar instÃ¢ncia na Evolution API
    const response = await evolutionApiClient.post('/instance/create', {
      instanceName,
      integration: 'WHATSAPP-BAILEYS',
      webhook: {
        url: `${process.env.BACKEND_URL}/webhooks/evolution`,
        webhook_by_events: true,
        events: ['QRCODE_UPDATED', 'CONNECTION_UPDATE', 'MESSAGES_UPSERT']
      }
    });
    
    // Atualizar DB
    await db.multiAgentTenants.update({
      where: { id: tenantId },
      data: {
        evolution_instance_id: instanceName,
        whatsapp_status: 'waiting_qr',
        evolution_instance_created_at: new Date()
      }
    });
    
    return instanceName;
  }
  
  async deleteInstanceForTenant(tenantId: string): Promise<void> {
    const tenant = await db.multiAgentTenants.findUnique({ where: { id: tenantId } });
    
    if (!tenant.evolution_instance_id) return;
    
    // Deletar da Evolution API
    await evolutionApiClient.delete(`/instance/delete/${tenant.evolution_instance_id}`);
    
    // Limpar DB
    await db.multiAgentTenants.update({
      where: { id: tenantId },
      data: {
        evolution_instance_id: null,
        whatsapp_status: 'pending',
        whatsapp_number: null,
        whatsapp_connected_at: null
      }
    });
  }
  
  async getInstanceStatus(instanceName: string): Promise<any> {
    return await evolutionApiClient.get(`/instance/connectionState/${instanceName}`);
  }
}

Fase 4: Endpoints API (Semana 2)
// routes/whatsapp.routes.ts

// POST /api/v1/tenants/me/whatsapp/activate
// Cria instÃ¢ncia Evolution para o tenant logado
router.post('/whatsapp/activate', async (req, res) => {
  const tenantId = req.user.tenantId;
  
  const instanceName = await instanceManager.createInstanceForTenant(tenantId);
  
  res.json({ 
    success: true, 
    instanceName,
    message: 'InstÃ¢ncia criada. Aguarde QR Code.'
  });
});

// DELETE /api/v1/tenants/me/whatsapp/deactivate
router.delete('/whatsapp/deactivate', async (req, res) => {
  const tenantId = req.user.tenantId;
  
  await instanceManager.deleteInstanceForTenant(tenantId);
  
  res.json({ success: true });
});

// GET /api/v1/tenants/me/whatsapp/status
router.get('/whatsapp/status', async (req, res) => {
  const tenant = await db.multiAgentTenants.findUnique({
    where: { id: req.user.tenantId }
  });
  
  res.json({
    status: tenant.whatsapp_status,
    number: tenant.whatsapp_number,
    connected_at: tenant.whatsapp_connected_at,
    has_instance: !!tenant.evolution_instance_id
  });
});

Fase 5: Monitoramento e Alerts (Semana 3)
// Cron job - verificar instÃ¢ncias problemÃ¡ticas
cron.schedule('*/5 * * * *', async () => {
  const tenants = await db.multiAgentTenants.findMany({
    where: { 
      evolution_instance_id: { not: null },
      whatsapp_status: 'connected'
    }
  });
  
  for (const tenant of tenants) {
    try {
      const status = await instanceManager.getInstanceStatus(tenant.evolution_instance_id);
      
      if (status.state !== 'open') {
        // Desconectou - atualizar status e notificar
        await db.multiAgentTenants.update({
          where: { id: tenant.id },
          data: { 
            whatsapp_status: 'disconnected',
            whatsapp_disconnected_at: new Date()
          }
        });
        
        await notificationService.send(tenant.id, {
          type: 'whatsapp_disconnected',
          message: 'Seu WhatsApp foi desconectado. Reconecte no painel.'
        });
      }
    } catch (error) {
      logger.error(`Erro ao verificar instÃ¢ncia ${tenant.evolution_instance_id}`, error);
    }
  }
});

7. Riscos e MitigaÃ§Ãµes
Risco	Probabilidade	Impacto	MitigaÃ§Ã£o
Servidor Evolution sobrecarregado	ğŸŸ¡ MÃ©dia	ğŸ”´ Alto	Monitorar RAM/CPU, alertar em 80%, provisionar segundo servidor
InstÃ¢ncia travada	ğŸŸ¡ MÃ©dia	ğŸŸ¡ MÃ©dio	Endpoint /instance/restart, cron de health check
Tenant deletado mas instÃ¢ncia permanece	ğŸŸ¢ Baixa	ğŸŸ¡ MÃ©dio	Soft delete com cleanup job, ou cascade delete
Custo crescente	ğŸŸ¢ Baixa	ğŸŸ¡ MÃ©dio	Dashboard de mÃ©tricas, alertar se > budget mensal
Banimento WhatsApp (Baileys)	ğŸŸ¡ MÃ©dia	ğŸ”´ Alto	Docs claras (uso por prÃ³pria conta), considerar Cloud API futuro
8. Quando Migrar para Modelo C (Pool DinÃ¢mico)?
Considere migrar quando:

âœ… Mais de 500 tenants ativos
âœ… Taxa de churn alta (>30% tenants inativos por mÃªs)
âœ… Custo de servidor > $500/mÃªs
âœ… Equipe DevOps experiente disponÃ­vel
âœ… ROI calculado (economia > custo de desenvolvimento)
NÃ£o migre se:

âŒ Menos de 200 tenants
âŒ Time pequeno (foco em produto, nÃ£o infra)
âŒ Modelo A funciona bem
9. ReferÃªncias
DocumentaÃ§Ã£o:

Evolution API Instances Overview
Evolution Manager v2
System Architecture Overview
Performance:

Baileys Memory Usage Discussion
Multi-Tenant Architecture Best Practices
Casos Reais:

Evolution Manager GitHub
Evolution + Chatwoot Docker Setup
Update Todos
 Pesquisar documentaÃ§Ãµes oficiais (Evolution API e Chatwoot)
 AnÃ¡lise 1: Arquitetura Evolution + Chatwoot (modelos de integraÃ§Ã£o)
 AnÃ¡lise 2: Modelo de InstÃ¢ncias Evolution (gerenciamento)
 Analisando fluxo de QR Code e reconexÃ£o
 Compilar e formatar os 3 documentos tÃ©cnicos
ğŸ“‹ ANÃLISE 3: FLUXO QR CODE + RECONEXÃƒO
1. Contexto
Tenant ativa assinatura WhatsApp â†’ precisa conectar nÃºmero â†’ escanear QR Code. WhatsApp pode desconectar a qualquer momento â†’ tenant precisa reconectar. QuestÃ£o: Como implementar fluxo completo de QR Code e reconexÃ£o?

2. Pesquisa TÃ©cnica
2.1 Ciclo de Vida de ConexÃ£o WhatsApp
Renderizando diagrama...

2.2 Webhooks Evolution - Eventos de ConexÃ£o
CONNECTION_UPDATE:

Disparado quando estado da conexÃ£o muda.

Payload Exemplo:

{
  "event": "connection.update",
  "instance": "tenant_123",
  "data": {
    "instance": "tenant_123",
    "state": "open",  // "close", "connecting", "open"
    "statusReason": 200
  },
  "destination": "https://backend.com/webhooks/evolution",
  "date_time": "2026-01-22T14:59:30.777Z",
  "server_url": "http://evolution:8080",
  "apikey": "xxx"
}

Estados possÃ­veis:

close - desconectado
connecting - conectando
open - conectado com sucesso
QRCODE_UPDATED:

Disparado quando QR Code Ã© gerado ou atualizado.

Payload Exemplo:

{
  "event": "qrcode.updated",
  "instance": "tenant_123",
  "data": {
    "qr": "2@67576ghf/RMXr8A2IP3/...",  // String base64 do QR
    "instance": "tenant_123"
  },
  "destination": "https://backend.com/webhooks/evolution",
  "date_time": "2026-01-22T15:00:01.123Z"
}

Fontes:

Evolution API Webhooks Documentation
QR Code Webhook Example
2.3 GeraÃ§Ã£o de QR Code
MÃ©todo 1: Via Webhook (Recomendado)

ApÃ³s criar instÃ¢ncia, Evolution automaticamente:

Gera QR Code
Dispara webhook QRCODE_UPDATED
Backend armazena QR Code (cache/DB)
Frontend consulta backend para exibir
MÃ©todo 2: Polling API

Endpoint: GET /instance/connect/{instance}

Response:

{
  "code": "success",
  "qrcode": {
    "pairingCode": null,
    "base64": "data:image/png;base64,iVBORw0KGgoAAAANS...",
    "count": 1
  }
}

ObservaÃ§Ãµes:

QR Code expira apÃ³s ~60 segundos
Novo QR gerado automaticamente (webhook dispara novamente)
MÃ¡ximo ~4-5 QR Codes antes de precisar recriar instÃ¢ncia
Fonte: Evolution API v2.0 Postman

2.4 Problemas Conhecidos
Bug: QR Code Infinite Loop (Resolvido em v2.3.4+):

InstÃ¢ncias entravam em loop infinito tentando reconectar
Fix: adiciona check isInitialConnection para permitir primeiro QR Code
Bug: Webhook para apÃ³s QR Code (Issue #1520):

Webhooks paravam de funcionar apÃ³s correÃ§Ã£o de QR Code
SoluÃ§Ã£o: garantir webhook configurado ANTES de gerar QR
Fonte:

QR Code Loop Fix PR
Webhookåœæ­¢ Issue
3. Fluxos Detalhados
3.1 FLUXO COMPLETO: AtivaÃ§Ã£o Primeira Vez
Renderizando diagrama...

3.2 FLUXO: ReconexÃ£o (WhatsApp Desconectou)
Renderizando diagrama...

3.3 FLUXO: Monitoramento ContÃ­nuo (Cron Job)
Renderizando diagrama...

4. Endpoints Backend NecessÃ¡rios
4.1 POST /api/v1/tenants/me/whatsapp/activate
Request: Vazio (tenant identificado via JWT)

Response:

{
  "success": true,
  "message": "InstÃ¢ncia criada. QR Code serÃ¡ gerado em instantes.",
  "instance_id": "tenant_123"
}

LÃ³gica:

Verifica se tenant jÃ¡ tem evolution_instance_id â†’ erro se jÃ¡ tem
Cria instÃ¢ncia Evolution via API
Salva evolution_instance_id no DB
Atualiza whatsapp_status = "waiting_qr"
4.2 GET /api/v1/tenants/me/whatsapp/qrcode
Request: Vazio

Response:

{
  "qr": "data:image/png;base64,iVBORw0KGgoAAAANS...",
  "expires_at": "2026-01-22T15:01:00Z",
  "attempt": 1  // Quantos QR Codes jÃ¡ foram gerados
}

LÃ³gica:

Busca QR Code no cache (Redis) - chave: qr:tenant_123
Se nÃ£o encontrar, consulta Evolution API GET /instance/connect/{instance}
Retorna base64 do QR Code
Frontend renderiza como <img src={qr} />
4.3 GET /api/v1/tenants/me/whatsapp/status
Request: Vazio

Response:

{
  "status": "connected",  // "pending" | "waiting_qr" | "connecting" | "connected" | "disconnected"
  "number": "5511999999999",
  "connected_at": "2026-01-22T15:05:00Z",
  "disconnected_at": null,
  "has_instance": true
}

LÃ³gica:

Busca tenant no DB
Retorna campos relevantes
4.4 POST /api/v1/tenants/me/whatsapp/reconnect
Request: Vazio

Response:

{
  "success": true,
  "message": "Novo QR Code gerado. Escaneie para reconectar."
}

LÃ³gica:

Verifica se tenant tem instÃ¢ncia
Faz logout da sessÃ£o atual: DELETE /instance/logout/{instance}
ForÃ§a novo QR: GET /instance/connect/{instance}
Atualiza whatsapp_status = "waiting_qr"
4.5 DELETE /api/v1/tenants/me/whatsapp/disconnect
Request: Vazio

Response:

{
  "success": true,
  "message": "WhatsApp desconectado e instÃ¢ncia deletada."
}

LÃ³gica:

Deleta instÃ¢ncia Evolution: DELETE /instance/delete/{instance}
Limpa campos no DB:
evolution_instance_id = null
whatsapp_status = "pending"
whatsapp_number = null
4.6 POST /webhooks/evolution (Interno - nÃ£o exposto)
Request (de Evolution API):

{
  "event": "qrcode.updated" | "connection.update" | "messages.upsert",
  "instance": "tenant_123",
  "data": { ... }
}

Response: 200 OK

LÃ³gica:

app.post('/webhooks/evolution', async (req, res) => {
  const { event, instance, data } = req.body;
  
  // Encontrar tenant por instance
  const tenant = await db.multiAgentTenants.findFirst({
    where: { evolution_instance_id: instance }
  });
  
  if (!tenant) {
    logger.warn(`InstÃ¢ncia ${instance} nÃ£o encontrada no DB`);
    return res.status(200).send('OK');
  }
  
  switch (event) {
    case 'qrcode.updated':
      // Armazenar QR Code no cache
      await redis.setex(`qr:${instance}`, 60, data.qr);  // Expira em 60s
      break;
      
    case 'connection.update':
      if (data.state === 'open') {
        // Conectado
        await db.multiAgentTenants.update({
          where: { id: tenant.id },
          data: {
            whatsapp_status: 'connected',
            whatsapp_connected_at: new Date()
            // Extrair nÃºmero do WhatsApp (data pode conter)
          }
        });
      } else if (data.state === 'close') {
        // Desconectado
        await db.multiAgentTenants.update({
          where: { id: tenant.id },
          data: {
            whatsapp_status: 'disconnected',
            whatsapp_disconnected_at: new Date()
          }
        });
        
        // Notificar tenant
        await notificationService.send(tenant.id, {
          type: 'whatsapp_disconnected',
          title: 'WhatsApp Desconectado',
          message: 'Reconecte seu WhatsApp no painel.'
        });
      } else if (data.state === 'connecting') {
        await db.multiAgentTenants.update({
          where: { id: tenant.id },
          data: { whatsapp_status: 'connecting' }
        });
      }
      break;
      
    case 'messages.upsert':
      // Processar mensagem recebida
      // (fora do escopo deste documento - vai para Chatwoot)
      break;
  }
  
  res.status(200).send('OK');
});

5. Ajustes no Schema SQL
-- Verificar se colunas jÃ¡ existem (algumas podem jÃ¡ estar no schema)
-- âœ… = jÃ¡ existe, â“ = precisa adicionar

ALTER TABLE multi_agent_tenants 
ADD COLUMN IF NOT EXISTS evolution_instance_id VARCHAR(255);     -- âœ… JÃ¡ existe
ADD COLUMN IF NOT EXISTS whatsapp_number VARCHAR(20);             -- âœ… JÃ¡ existe
ADD COLUMN IF NOT EXISTS whatsapp_status VARCHAR(20) DEFAULT 'pending';  -- â“ ADICIONAR
ADD COLUMN IF NOT EXISTS whatsapp_connected_at TIMESTAMPTZ;       -- â“ ADICIONAR
ADD COLUMN IF NOT EXISTS whatsapp_disconnected_at TIMESTAMPTZ;    -- â“ ADICIONAR
ADD COLUMN IF NOT EXISTS evolution_instance_created_at TIMESTAMPTZ;  -- â“ ADICIONAR

-- Ãndices para performance
CREATE INDEX IF NOT EXISTS idx_whatsapp_status ON multi_agent_tenants(whatsapp_status);
CREATE INDEX IF NOT EXISTS idx_evolution_instance ON multi_agent_tenants(evolution_instance_id);

-- Check constraint para valores vÃ¡lidos
ALTER TABLE multi_agent_tenants 
ADD CONSTRAINT whatsapp_status_check 
CHECK (whatsapp_status IN ('pending', 'creating', 'waiting_qr', 'connecting', 'connected', 'disconnected', 'error'));

6. Frontend - Wireframe/Fluxo
Tela 1: WhatsApp NÃ£o Conectado
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± WhatsApp Multi-Agente                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Status: âšª NÃ£o Conectado                â”‚
â”‚                                          â”‚
â”‚  Para comeÃ§ar a usar o atendimento       â”‚
â”‚  multiagente, conecte seu WhatsApp:      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   ğŸš€ Ativar WhatsApp       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tela 2: Aguardando QR Code
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± WhatsApp Multi-Agente                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Status: ğŸ”„ Gerando QR Code...           â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚                            â”‚          â”‚
â”‚  â”‚     [Spinner Animation]    â”‚          â”‚
â”‚  â”‚                            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â”‚
â”‚  Aguarde, estamos preparando sua         â”‚
â”‚  conexÃ£o WhatsApp...                     â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tela 3: Exibindo QR Code
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± WhatsApp Multi-Agente                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Status: ğŸ“· Aguardando Scan              â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       â”‚          â”‚
â”‚  â”‚   â–ˆâ–ˆ  QR CODE  â–ˆâ–ˆ          â”‚          â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â”‚
â”‚  ğŸ“± Passos para conectar:                â”‚
â”‚  1. Abra WhatsApp no celular             â”‚
â”‚  2. Toque em Mais > Dispositivos         â”‚
â”‚     Conectados                           â”‚
â”‚  3. Toque em Conectar Dispositivo        â”‚
â”‚  4. Aponte o celular para este QR Code   â”‚
â”‚                                          â”‚
â”‚  â±ï¸ QR Code expira em 45 segundos        â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tela 4: Conectado
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± WhatsApp Multi-Agente                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Status: âœ… Conectado                    â”‚
â”‚  NÃºmero: +55 11 99999-9999               â”‚
â”‚  Desde: 22/01/2026 Ã s 15:05              â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Seu WhatsApp estÃ¡ ativo   â”‚          â”‚
â”‚  â”‚  e pronto para atender!    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â”‚
â”‚  [ğŸ“Š Ver Conversas]  [âš™ï¸ Configurar]   â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   ğŸ”Œ Desconectar WhatsApp  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tela 5: Desconectado (Precisa Reconectar)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± WhatsApp Multi-Agente                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  âš ï¸ STATUS: DESCONECTADO                 â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Seu WhatsApp foi desconectado.   â”‚  â”‚
â”‚  â”‚  Clique abaixo para reconectar.   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  Ãšltimo nÃºmero: +55 11 99999-9999        â”‚
â”‚  Desconectado em: 23/01/2026 Ã s 10:30    â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   ğŸ”„ Reconectar WhatsApp   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

7. Frontend - ImplementaÃ§Ã£o React
// pages/WhatsAppConnection.tsx

import { useState, useEffect } from 'react';
import { QRCodeSVG } from 'qrcode.react';

type WhatsAppStatus = 'pending' | 'waiting_qr' | 'connecting' | 'connected' | 'disconnected';

export default function WhatsAppConnection() {
  const [status, setStatus] = useState<WhatsAppStatus>('pending');
  const [qrCode, setQrCode] = useState<string | null>(null);
  const [number, setNumber] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  // Buscar status inicial
  useEffect(() => {
    fetchStatus();
  }, []);

  // Polling QR Code quando status = waiting_qr
  useEffect(() => {
    if (status === 'waiting_qr') {
      const interval = setInterval(fetchQRCode, 2000);  // A cada 2s
      return () => clearInterval(interval);
    }
  }, [status]);

  // Polling status quando status = connecting
  useEffect(() => {
    if (status === 'connecting') {
      const interval = setInterval(fetchStatus, 1000);  // A cada 1s
      return () => clearInterval(interval);
    }
  }, [status]);

  const fetchStatus = async () => {
    const res = await fetch('/api/v1/tenants/me/whatsapp/status');
    const data = await res.json();
    setStatus(data.status);
    setNumber(data.number);
  };

  const fetchQRCode = async () => {
    const res = await fetch('/api/v1/tenants/me/whatsapp/qrcode');
    if (res.ok) {
      const data = await res.json();
      setQrCode(data.qr);
    }
  };

  const handleActivate = async () => {
    setLoading(true);
    await fetch('/api/v1/tenants/me/whatsapp/activate', { method: 'POST' });
    setStatus('waiting_qr');
    setLoading(false);
  };

  const handleReconnect = async () => {
    setLoading(true);
    await fetch('/api/v1/tenants/me/whatsapp/reconnect', { method: 'POST' });
    setStatus('waiting_qr');
    setLoading(false);
  };

  const handleDisconnect = async () => {
    if (!confirm('Tem certeza que deseja desconectar?')) return;
    await fetch('/api/v1/tenants/me/whatsapp/disconnect', { method: 'DELETE' });
    setStatus('pending');
    setNumber(null);
  };

  // RenderizaÃ§Ã£o condicional baseada no status
  if (status === 'pending') {
    return (
      <div className="card">
        <h2>ğŸ“± WhatsApp Multi-Agente</h2>
        <p>Status: âšª NÃ£o Conectado</p>
        <button onClick={handleActivate} disabled={loading}>
          ğŸš€ Ativar WhatsApp
        </button>
      </div>
    );
  }

  if (status === 'waiting_qr') {
    return (
      <div className="card">
        <h2>ğŸ“± WhatsApp Multi-Agente</h2>
        <p>Status: ğŸ“· Aguardando Scan</p>
        {qrCode ? (
          <img src={qrCode} alt="QR Code" width={300} />
        ) : (
          <p>ğŸ”„ Gerando QR Code...</p>
        )}
        <ol>
          <li>Abra WhatsApp no celular</li>
          <li>Toque em Mais &gt; Dispositivos Conectados</li>
          <li>Toque em Conectar Dispositivo</li>
          <li>Aponte o celular para este QR Code</li>
        </ol>
      </div>
    );
  }

  if (status === 'connecting') {
    return (
      <div className="card">
        <h2>ğŸ“± WhatsApp Multi-Agente</h2>
        <p>Status: ğŸ”„ Conectando...</p>
        <p>Aguarde, estamos finalizando a conexÃ£o...</p>
      </div>
    );
  }

  if (status === 'connected') {
    return (
      <div className="card">
        <h2>ğŸ“± WhatsApp Multi-Agente</h2>
        <p>Status: âœ… Conectado</p>
        <p>NÃºmero: {number}</p>
        <button onClick={handleDisconnect}>ğŸ”Œ Desconectar WhatsApp</button>
      </div>
    );
  }

  if (status === 'disconnected') {
    return (
      <div className="card">
        <h2>ğŸ“± WhatsApp Multi-Agente</h2>
        <p>âš ï¸ STATUS: DESCONECTADO</p>
        <p>Ãšltimo nÃºmero: {number}</p>
        <button onClick={handleReconnect} disabled={loading}>
          ğŸ”„ Reconectar WhatsApp
        </button>
      </div>
    );
  }

  return null;
}

8. Riscos e MitigaÃ§Ãµes
Risco	Probabilidade	Impacto	MitigaÃ§Ã£o
QR Code nÃ£o gerado	ğŸŸ¡ MÃ©dia	ğŸŸ¡ MÃ©dio	Timeout de 30s, botÃ£o "Gerar Novo QR", logs detalhados
Webhook nÃ£o chega	ğŸŸ¡ MÃ©dia	ğŸ”´ Alto	Polling fallback: GET /instance/connectionState a cada 5s
QR expira antes de scan	ğŸŸ¢ Baixa	ğŸŸ¢ Baixo	Novo QR gerado automaticamente, informar usuÃ¡rio
Tenant escaneia mas nÃ£o conecta	ğŸŸ¡ MÃ©dia	ğŸŸ¡ MÃ©dio	Status "connecting" com timeout 60s, instruÃ§Ãµes claras
WhatsApp bane nÃºmero (Baileys)	ğŸŸ¡ MÃ©dia	ğŸ”´ Alto	Docs de uso responsÃ¡vel, considerar Cloud API para high-volume
Cache Redis falha	ğŸŸ¢ Baixa	ğŸŸ¡ MÃ©dio	Fallback para consulta direta Evolution API
9. Checklist de ImplementaÃ§Ã£o
Backend:
 Adicionar colunas whatsapp_status, whatsapp_connected_at, whatsapp_disconnected_at
 Criar endpoint POST /api/v1/tenants/me/whatsapp/activate
 Criar endpoint GET /api/v1/tenants/me/whatsapp/qrcode
 Criar endpoint GET /api/v1/tenants/me/whatsapp/status
 Criar endpoint POST /api/v1/tenants/me/whatsapp/reconnect
 Criar endpoint DELETE /api/v1/tenants/me/whatsapp/disconnect
 Implementar webhook POST /webhooks/evolution
 Configurar Redis para cache de QR Codes
 Cron job para monitorar conexÃµes (5 min)
 Sistema de notificaÃ§Ãµes (email + push)
Frontend:
 Tela "Ativar WhatsApp" (botÃ£o inicial)
 Tela "Aguardando QR Code" (loading)
 Tela "Escanear QR Code" (exibiÃ§Ã£o + instruÃ§Ãµes)
 Tela "WhatsApp Conectado" (status + desconectar)
 Tela "Reconectar WhatsApp" (banner + botÃ£o)
 Polling automÃ¡tico para QR Code (2s)
 Polling automÃ¡tico para status (1s quando connecting)
 Tratamento de erros e timeouts
Testes:
 Fluxo completo ativaÃ§Ã£o â†’ QR â†’ conexÃ£o
 Fluxo desconexÃ£o â†’ reconexÃ£o
 QR Code expira â†’ novo QR gerado
 Webhook nÃ£o chega â†’ fallback polling
 MÃºltiplos tenants simultÃ¢neos
 Cancelamento de assinatura â†’ delete instÃ¢ncia
10. ReferÃªncias
DocumentaÃ§Ã£o:

Evolution API Webhooks
Evolution API v2.0 Postman
Issues e Fixes:

QR Code Infinite Loop Fix
Webhookåœæ­¢ After QR Code
QR Code Generation Issues
Tutoriais:

Evolution + Chatwoot Docker
Evolution API SDK
Update Todos
 Pesquisar documentaÃ§Ãµes oficiais (Evolution API e Chatwoot)
 AnÃ¡lise 1: Arquitetura Evolution + Chatwoot (modelos de integraÃ§Ã£o)
 AnÃ¡lise 2: Modelo de InstÃ¢ncias Evolution (gerenciamento)
 AnÃ¡lise 3: Fluxo QR Code + ReconexÃ£o (implementaÃ§Ã£o tÃ©cnica)
 Compilar e formatar os 3 documentos tÃ©cnicos
ğŸ“Š RESUMO EXECUTIVO - ANÃLISE COMPLETA EVOLUTION + CHATWOOT
âœ… AnÃ¡lises ConcluÃ­das
Kiro/Antigravity entregando 3 documentos tÃ©cnicos completos conforme solicitado:

1ï¸âƒ£ ANÃLISE 1: ARQUITETURA EVOLUTION + CHATWOOT
DecisÃ£o Recomendada: Arquitetura HÃ­brida

IntegraÃ§Ã£o nativa Evolution â†’ Chatwoot (mensagens fluem automaticamente)
Backend monitora via webhooks paralelos (analytics, controle seletivo)
Melhor custo-benefÃ­cio: simplicidade inicial + escalabilidade futura
Justificativa:

Fase 1 (MVP): integraÃ§Ã£o nativa = setup rÃ¡pido
Fase 2 (crescimento): backend jÃ¡ "vÃª tudo", adiciona lÃ³gicas sob demanda
Fase 3 (escala): migraÃ§Ã£o suave para orquestraÃ§Ã£o total se necessÃ¡rio
2ï¸âƒ£ ANÃLISE 2: MODELO DE INSTÃ‚NCIAS EVOLUTION
DecisÃ£o Recomendada: 1 InstÃ¢ncia por Tenant

NÃºmeros:

Consumo: ~500 MB RAM por instÃ¢ncia
100 tenants = servidor 64 GB (~$120/mÃªs)
500 tenants = cluster ($400-600/mÃªs)
Justificativa:

Modelo B (compartilhado) = inviÃ¡vel (cada afiliado precisa nÃºmero prÃ³prio)
Modelo C (pool dinÃ¢mico) = over-engineering para <500 tenants
Modelo A = simplicidade, isolamento total, custo linear previsÃ­vel
Quando migrar para Pool DinÃ¢mico:

SÃ³ apÃ³s 500+ tenants ativos
Alta taxa de churn (>30% inativos/mÃªs)
Custo servidor > $500/mÃªs
3ï¸âƒ£ ANÃLISE 3: FLUXO QR CODE + RECONEXÃƒO
Deliverables:

âœ… Diagramas de sequÃªncia completos (ativaÃ§Ã£o + reconexÃ£o)
âœ… 6 endpoints backend especificados com payloads
âœ… Ajustes schema SQL (3 colunas novas)
âœ… Wireframes de 5 telas do painel
âœ… CÃ³digo React completo (polling automÃ¡tico)
âœ… Webhook handler TypeScript
âœ… Cron job de monitoramento
Schema SQL Novo:

ALTER TABLE multi_agent_tenants ADD:
- whatsapp_status VARCHAR(20)           -- "pending" â†’ "connected"
- whatsapp_connected_at TIMESTAMPTZ
- whatsapp_disconnected_at TIMESTAMPTZ

ğŸ¯ RecomendaÃ§Ãµes Finais - Roadmap
Semana 1-2: Infraestrutura
Provisionar servidor Evolution API (16 GB RAM inicial)
Configurar Redis + PostgreSQL + S3/MinIO
Ajustar schema SQL (3 colunas)
Semana 2-3: Backend
Implementar 6 endpoints WhatsApp
Webhook Evolution handler
Cron job monitoramento (5 min)
Sistema notificaÃ§Ãµes (email desconexÃ£o)
Semana 3-4: Frontend
Tela ativaÃ§Ã£o WhatsApp
QR Code com polling (2s)
Status dashboard
ReconexÃ£o flow
Semana 4: Testes & Deploy
Testes de fluxo completo
Deploy staging â†’ production
DocumentaÃ§Ã£o operacional
ğŸ“š ReferÃªncias Consolidadas
DocumentaÃ§Ã£o Oficial:

Evolution API Introduction
Evolution API Chatwoot Integration
Evolution API Webhooks
Chatwoot API Reference
Chatwoot Agent Bots
Chatwoot Webhooks
ImplementaÃ§Ãµes de ReferÃªncia:

Evolution + Chatwoot Docker Setup
Evolution API SDK
Evolution Manager v2
Issues CrÃ­ticos Conhecidos:

Bug: Quoted Message Context Lost
QR Code Infinite Loop Fix
Webhookåœæ­¢ After QR Code
Performance & Arquitetura:

Baileys Memory Usage Discussion
System Architecture Overview
Multi-Tenant Architecture Guide
âš ï¸ Riscos Principais & MitigaÃ§Ãµes
Risco	MitigaÃ§Ã£o
Banimento WhatsApp (Baileys)	Docs de uso responsÃ¡vel, considerar Cloud API para high-volume
Bug integraÃ§Ã£o nativa Evolution-Chatwoot	Webhooks backend detectam inconsistÃªncias, alertas imediatos
Servidor Evolution sobrecarregado	Monitorar RAM/CPU, alertar 80%, escalar horizontalmente
WhatsApp desconexÃµes frequentes	NotificaÃ§Ãµes automÃ¡ticas (email+push), UX reconexÃ£o simples
ğŸ’° Estimativa de Custos
Infraestrutura Inicial (100 tenants):

Servidor Evolution API: $120/mÃªs (64 GB RAM)
Chatwoot Server: $40/mÃªs (8 GB RAM)
Redis + PostgreSQL: $20/mÃªs
S3 Storage: $10/mÃªs
Total: $190/mÃªs ($1.90/tenant)
Escalabilidade (500 tenants):

Cluster Evolution (2 servidores): $400/mÃªs
Chatwoot (scaled): $80/mÃªs
Infra adicional: $50/mÃªs
Total: $530/mÃªs ($1.06/tenant)
ğŸš€ PrÃ³ximos Passos Imediatos
Revisar anÃ¡lises e alinhar com time tÃ©cnico
Aprovar arquitetura hÃ­brida (AnÃ¡lise 1)
Aprovar modelo 1:1 instÃ¢ncias (AnÃ¡lise 2)
Iniciar implementaÃ§Ã£o seguindo roadmap 4 semanas
Provisionar servidor Evolution (primeira aÃ§Ã£o tÃ©cnica)
AnÃ¡lise completa entregue. NÃ£o foram feitos commits conforme solicitado - todo conteÃºdo acima estÃ¡ disponÃ­vel para revisÃ£o e uso.

Kiro/Antigravity standing by para esclarecimentos ou deep dives em pontos especÃ­ficos. ğŸ¤–

